<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Background (Free/Native) - Tulz.net</title>
    <meta name="description"
        content="Remove image backgrounds instantly in your browser. No API keys, no uploads to servers. 100% Free & Private.">
    <link rel="stylesheet" href="../css/style.css">
    <!-- COI Service Worker (Required for WASM/SharedArrayBuffer) -->
    <script src="../js/coi-serviceworker.js"></script>
    <!-- Load imgly background removal locally -->
    <script src="../js/imgly.js"></script>
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <a href="../index.html" class="logo">Tulz.net</a>
                <div class="nav-links">
                    <a href="../index.html">Home</a>
                    <a href="../index.html#image-tools">Image Tools</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="tool-container">
            <h1>Remove Background</h1>
            <p class="text-muted">100% Free. Runs locally using SharedArrayBuffer & WebAssembly.</p>

            <!-- Status Monitor -->
            <div id="status-box"
                style="margin-bottom: 2rem; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem; text-align: left;">
                <strong>System Status:</strong>
                <ul style="margin: 0; padding-left: 1.2rem;">
                    <li id="status-sw">Service Worker: Checking...</li>
                    <li id="status-sab">SharedArrayBuffer: Checking...</li>
                    <li id="status-lib">Library Loaded: Checking...</li>
                </ul>
            </div>

            <div id="drop-zone" class="upload-zone">
                <div class="tool-icon">ü™Ñ</div>
                <h3>Upload Image</h3>
                <p>Processing happens in your browser</p>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">Select
                    Image</button>
            </div>

            <div id="processing" style="display:none; text-align:center; padding:2rem;">
                <div class="spinner" style="font-size:3rem; animation: spin 1s infinite linear;">‚è≥</div>
                <p id="progress-text" style="margin-top:1rem;">Initializing AI Engine...</p>
                <pre id="debug-log"
                    style="text-align: left; background: #eee; padding: 10px; margin-top: 10px; height: 100px; overflow: auto; font-size: 0.8rem;"></pre>
            </div>

            <div id="result-stage" style="display: none; text-align: center;">
                <h3>Background Removed!</h3>
                <div
                    style="background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjZWVlIi8+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiNlZWUiLz48L3N2Zz4='); padding: 1rem; border-radius: 0.5rem; display: inline-block;">
                    <img id="result-img" style="max-width: 100%; max-height: 400px;">
                </div>
                <br><br>
                <a id="download-link" class="btn">Download HD Image</a>
                <button class="btn btn-secondary" onclick="location.reload()">Process Another</button>
            </div>

            <div id="error-msg" style="display:none; color:red; text-align:center; margin-top:1rem;"></div>
        </div>
    </main>

    <style>
        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script src="../js/main.js"></script>
    <script>
        const log = (msg) => {
            console.log(msg);
            const el = document.getElementById('debug-log');
            if (el) {
                el.innerText += msg + '\n';
                el.scrollTop = el.scrollHeight;
            }
        };

        // 1. Check Capabilities
        window.addEventListener('load', () => {
            // SW Check
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                document.getElementById('status-sw').innerHTML = "Service Worker: <span style='color:green'>Active</span>";
            } else {
                document.getElementById('status-sw').innerHTML = "Service Worker: <span style='color:orange'>Inactive (Reload Page)</span>";
            }

            // SharedArrayBuffer Check
            if (window.crossOriginIsolated) {
                document.getElementById('status-sab').innerHTML = "SharedArrayBuffer: <span style='color:green'>Available (High Performance)</span>";
            } else {
                document.getElementById('status-sab').innerHTML = "SharedArrayBuffer: <span style='color:red'>Unavailable (Will be Slow/Fail)</span>. Only works on https:// and localhost.";
            }

            // Library Check
            if (typeof imglyBackgroundRemoval !== 'undefined' || typeof window.imglyRemoveBackground === 'function') {
                document.getElementById('status-lib').innerHTML = "Library Loaded: <span style='color:green'>Yes</span>";
            } else {
                document.getElementById('status-lib').innerHTML = "Library Loaded: <span style='color:red'>Failed</span>";
            }
        });

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const processing = document.getElementById('processing');
        const resultStage = document.getElementById('result-stage');
        const errorMsg = document.getElementById('error-msg');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            dropZone.style.display = 'none';
            processing.style.display = 'block';
            errorMsg.style.display = 'none';
            log("Starting process...");

            try {
                let removeBgFn = window.imglyRemoveBackground;

                // Fallback discovery
                if (typeof removeBgFn !== 'function') {
                    if (window.imglyBackgroundRemoval && typeof window.imglyBackgroundRemoval.removeBackground === 'function') {
                        removeBgFn = window.imglyBackgroundRemoval.removeBackground;
                    }
                }

                // If library was loaded as UMD/module under different name in local file
                if (typeof removeBgFn !== 'function' && typeof imglyBackgroundRemoval === 'object') {
                    // Start guessing
                    if (imglyBackgroundRemoval.removeBackground) removeBgFn = imglyBackgroundRemoval.removeBackground;
                }

                if (typeof removeBgFn !== 'function') {
                    throw new Error("Library function not found. Check 'Library Loaded' status.");
                }

                log("Library found. Calling removeBackground...");

                // Config: Force public path if needed, or rely on defaults
                // We point to the CDN for ASSETS (wasm/onnx) because they are huge, but use local JS logic.
                const config = {
                    publicPath: "https://static.img.ly/background-removal-data/1.0.3/",
                    progress: (key, current, total) => {
                        const percent = Math.round((current / total) * 100);
                        document.getElementById('progress-text').innerText = `Loading Model (${key}): ${percent}%`;
                        log(`DL ${key}: ${percent}%`);
                    },
                    debug: true
                };

                const blob = await removeBgFn(file, config);

                log("Processing complete. Creating URL...");
                const url = URL.createObjectURL(blob);

                document.getElementById('result-img').src = url;
                document.getElementById('download-link').href = url;
                document.getElementById('download-link').download = 'no-bg-' + file.name.replace(/\.[^/.]+$/, "") + ".png";

                processing.style.display = 'none';
                resultStage.style.display = 'block';

            } catch (err) {
                console.error(err);
                log("ERROR: " + err.message);
                processing.querySelector('.spinner').style.display = 'none';
                errorMsg.innerHTML = "<strong>Error:</strong> " + err.message + "<br>Check the debug log above.";
                errorMsg.style.display = 'block';
            }
        });
    </script>
</body>

</html>