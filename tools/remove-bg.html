<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Background (Free/Native) - Tulz.net</title>
    <meta name="description"
        content="Remove image backgrounds instantly in your browser. No API keys, no uploads to servers. 100% Free & Private.">
    <link rel="stylesheet" href="../css/style.css">
    <!-- COI Service Worker (Required for WASM/SharedArrayBuffer) -->
    <script src="../js/coi-serviceworker.js"></script>
    <!-- Load imgly background removal -->
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.0.3/dist/imgly-background-removal.min.js"
        crossorigin="anonymous"></script>
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <a href="../index.html" class="logo">Tulz.net</a>
                <div class="nav-links">
                    <a href="../index.html">Home</a>
                    <a href="../index.html#image-tools">Image Tools</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="tool-container">
            <h1>Remove Background</h1>
            <p class="text-muted">100% Free. Runs locally on your device. No API Key required.</p>

            <div id="drop-zone" class="upload-zone">
                <div class="tool-icon">ü™Ñ</div>
                <h3>Upload Image</h3>
                <p>Processing happens in your browser</p>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">Select
                    Image</button>
            </div>

            <div id="processing" style="display:none; text-align:center; padding:2rem;">
                <div class="spinner" style="font-size:3rem; animation: spin 1s infinite linear;">‚è≥</div>
                <p style="margin-top:1rem;">Removing background... (loading AI models...)</p>
            </div>

            <div id="result-stage" style="display: none; text-align: center;">
                <h3>Background Removed!</h3>
                <div
                    style="background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjZWVlIi8+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiNlZWUiLz48L3N2Zz4='); padding: 1rem; border-radius: 0.5rem; display: inline-block;">
                    <img id="result-img" style="max-width: 100%; max-height: 400px;">
                </div>
                <br><br>
                <a id="download-link" class="btn">Download HD Image</a>
                <button class="btn btn-secondary" onclick="location.reload()">Process Another</button>
            </div>

            <div id="error-msg" style="display:none; color:red; text-align:center; margin-top:1rem;"></div>
        </div>
    </main>

    <style>
        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script src="../js/main.js"></script>
    <script>
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const processing = document.getElementById('processing');
        const resultStage = document.getElementById('result-stage');
        const errorMsg = document.getElementById('error-msg');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            dropZone.style.display = 'none';
            processing.style.display = 'block';
            errorMsg.style.display = 'none';

            try {
                // Check if the library loaded (It usually exposes 'imglyRemoveBackground' as a global function)
                // Sometimes it might be namespaced, let's try both common patterns.
                let removeBgFn = window.imglyRemoveBackground;

                if (typeof removeBgFn !== 'function') {
                    // Fallback check if it was loaded as an object
                    if (window.imglyBackgroundRemoval && typeof window.imglyBackgroundRemoval.removeBackground === 'function') {
                        removeBgFn = window.imglyBackgroundRemoval.removeBackground;
                    }
                }

                if (typeof removeBgFn !== 'function') {
                    throw new Error("Library failed to load (Global function not found). Check connection.");
                }

                // Run background removal
                // Using Blob input
                const blob = await removeBgFn(file, {
                    progress: (key, current, total) => {
                        console.log(`Downloading ${key}: ${current} of ${total}`);
                        const percent = Math.round((current / total) * 100);
                        processing.querySelector('p').innerText = `Removing background... (${percent}%)`;
                    }
                });

                const url = URL.createObjectURL(blob);

                document.getElementById('result-img').src = url;
                document.getElementById('download-link').href = url;
                document.getElementById('download-link').download = 'no-bg-' + file.name.replace(/\.[^/.]+$/, "") + ".png";

                processing.style.display = 'none';
                resultStage.style.display = 'block';

            } catch (err) {
                console.error(err);
                processing.style.display = 'none';
                dropZone.style.display = 'block';
                errorMsg.textContent = "Error: " + err.message + ". Please try refreshing the page.";
                errorMsg.style.display = 'block';
            }
        });
    </script>
</body>

</html>